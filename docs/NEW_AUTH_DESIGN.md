# 新認証システム設計書

## 概要
既存の「扶養わかるんです」のUX抜本改善に向けた認証システムの完全リデザイン。デモモード廃止、必須ログイン、プロフィール設定強制化を実現する。

## 要件

### 1. 認証の必須化
- **デモモード完全廃止** - 一切の例外なく認証を必須とする
- **未認証時の自動リダイレクト** - 保護されたページへのアクセス時は即座に/loginへ
- **セッション管理の厳格化** - トークン期限切れ時の自動ログアウト

### 2. オンボーディングの強制化
- **プロフィール未完了時の強制遷移** - ダッシュボード等へのアクセスを完全ブロック
- **段階的プロフィール設定** - 必須項目を明確に定義し、完了まで他画面への遷移を禁止
- **離脱防止** - ブラウザバック等での離脱を検知し、設定継続を促す

### 3. 収入管理の簡素化
- **1-12月モデル** - 年度等の複雑な概念を排除し、単純な暦年ベースに統一
- **手入力優先** - 銀行API連携はオプション、基本は手入力で完結
- **予測機能** - 未来月の収入予測をサポート

## アーキテクチャ

### ルーティング構造
```
/ (landing) 
├── /login (認証必須外)
├── /auth/callback (認証必須外)
└── /app/* (認証必須エリア)
    ├── /onboarding (プロフィール未完了時のみ)
    ├── /dashboard (プロフィール完了後)
    └── /settings (プロフィール完了後)
```

### 認証フロー
1. **初回アクセス** → `/login`画面表示
2. **認証成功** → プロフィール完了状態をチェック
3. **未完了** → `/onboarding`へ強制遷移
4. **完了済み** → `/dashboard`へ遷移

### プロフィール必須項目
```typescript
interface RequiredProfile {
  birth_year: number          // 生年（年齢計算用）
  student_type: StudentType   // 学生種別（大学生、専門学生等）
  support_type: SupportType   // 扶養状況（完全扶養、一部扶養、独立）
  insurance: InsuranceType    // 健康保険（親の保険、国保、社保）
  monthly_income_target: number // 月収目標（円）
}
```

### オンボーディングステップ
1. **基本情報** - 生年月日、学生種別
2. **扶養状況** - 親の扶養に入っているか（分かりやすい日本語）
3. **健康保険** - 親の健康保険に入っているか
4. **月収目標** - 毎月どれくらい稼ぎたいか

## UX改善点

### 文言の日常語化
```typescript
// Before: "完全扶養"
// After: "親の扶養に入っていますか？"

// Before: "健康保険種別"  
// After: "健康保険はどこに入っていますか？"

// Before: "年間所得見込み"
// After: "毎月どれくらい稼ぎたいですか？"
```

### エラーメッセージの明確化
- **原因** と **解決方法** を必ず併記
- **次にやるべきこと** を具体的に示す
- 専門用語を避け、学生が理解しやすい言葉を使用

## 実装方針

### Phase 1: 認証システムの厳格化
1. デモモード関連コードの完全削除
2. 認証ミドルウェアの実装
3. 保護ルートの設定

### Phase 2: オンボーディングシステム
1. プロフィール完了判定ロジック
2. 強制リダイレクト機能
3. 新オンボーディングUI

### Phase 3: 収入管理の簡素化
1. 月次収入入力UI
2. YTD計算の自動化
3. 予測機能の実装

### Phase 4: UX改善
1. 文言の全面見直し
2. エラーハンドリングの強化
3. ユーザビリティテスト

## セキュリティ考慮事項

### データ保護
- **個人情報の最小化** - 必要最小限の情報のみ収集
- **暗号化** - 機密情報の適切な暗号化
- **アクセス制御** - Row Level Securityの厳格な適用

### セッション管理
- **適切な期限設定** - セキュリティと利便性のバランス
- **自動ログアウト** - 非アクティブ時の自動切断
- **並行セッション制限** - 複数デバイスでの同時利用制限

## 成功指標

### 定量指標
- **離脱率の削減** - オンボーディング完了率 >90%
- **エラー率の削減** - ユーザーエラー発生率 <5%
- **認証成功率** - ログイン成功率 >95%

### 定性指標
- **ユーザビリティ** - 「使いやすい」評価 >4.0/5.0
- **理解しやすさ** - 「分かりやすい」評価 >4.0/5.0
- **信頼性** - システムエラー報告数の大幅削減